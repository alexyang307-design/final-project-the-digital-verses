<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Digital Verses</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Montserrat:wght@200;400&display=swap');

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #050505;
            color: #e0e0e0;
            overflow: hidden; /* Prevent scrolling on the main page */
        }

        h1, h2, h3, .serif {
            font-family: 'Cormorant Garamond', serif;
        }

        /* Custom scrollbar for the text area */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* Canvas Container */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
        }

        /* UI Overlay */
        #ui-layer {
            position: relative;
            z-index: 10;
            pointer-events: none; /* Let clicks pass through to canvas */
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .interactive-area {
            pointer-events: auto; /* Re-enable clicks for buttons/text */
        }

        /* Slider styling for the 'Rest' sketch */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            height: 4px;
            border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -6px; 
        }
        
        /* Fade transition */
        .fade-enter { opacity: 0; transition: opacity 1s ease-in; }
        .fade-enter-active { opacity: 1; }
        .fade-exit { opacity: 1; transition: opacity 0.5s ease-out; }
        .fade-exit-active { opacity: 0; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer" class="p-6 md:p-10">
        
        <div class="flex justify-between items-start interactive-area">
            <div class="max-w-md">
                <h1 class="text-3xl md:text-4xl italic text-white tracking-wide mb-2">The Digital Verses</h1>
                <div id="poetry-display" class="bg-black/40 backdrop-blur-sm p-4 rounded-lg border border-white/10 text-gray-300 text-sm md:text-lg leading-relaxed shadow-xl transition-all duration-500 min-h-[100px]">
                    <p class="italic opacity-80">Select a chapter to begin the journey...</p>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center w-full pb-8 interactive-area">
            
            <div class="flex flex-wrap justify-center gap-4 mb-6">
                <button onclick="loadSketch('ocean')" class="px-6 py-2 border border-white/20 rounded-full hover:bg-white/10 hover:border-white/50 transition-all text-sm tracking-widest uppercase backdrop-blur-md">
                    Ch.1 The Ocean
                </button>
                <button onclick="loadSketch('forest')" class="px-6 py-2 border border-white/20 rounded-full hover:bg-white/10 hover:border-white/50 transition-all text-sm tracking-widest uppercase backdrop-blur-md">
                    Ch.2 The Forest
                </button>
                <button onclick="loadSketch('galaxy')" class="px-6 py-2 border border-white/20 rounded-full hover:bg-white/10 hover:border-white/50 transition-all text-sm tracking-widest uppercase backdrop-blur-md">
                    Ch.3 The Galaxy
                </button>
                <button onclick="loadSketch('rest')" class="px-6 py-2 border border-white/20 rounded-full hover:bg-white/10 hover:border-white/50 transition-all text-sm tracking-widest uppercase backdrop-blur-md">
                    Verse 2: What You Feel
                </button>
            </div>
            
            <div id="loading-indicator" class="text-xs tracking-widest opacity-0 transition-opacity duration-300 text-blue-300">
                LOADING AUDIO...
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        let currentP5 = null;
        
        // Audio URLs UPDATED for local files
        const audioFiles = {
            ocean: 'ocean.mp3',
            forest: 'forest.mp3',
            galaxy: 'galaxy.mp3',
            rest: 'rest.mp3'
        };

        // Poetry Content
        const poetryContent = {
            ocean: `
                <h3 class="serif text-xl text-blue-200 mb-2">Chapter 1: The Ocean</h3>
                <p class="serif italic">"The waves whisper secrets to the shore,<br>
                Drifting particles in the deep blue core.<br>
                A dance of currents, wild and free,<br>
                Lost in the rhythm of the timeless sea."</p>
            `,
            forest: `
                <h3 class="serif text-xl text-green-200 mb-2">Chapter 2: The Forest</h3>
                <p class="serif italic">"Vines creeping upwards to the light,<br>
                Silent growers in the velvet night.<br>
                Roots entwined in the earth below,<br>
                Watching the ancient clusters grow."</p>
            `,
            galaxy: `
                <h3 class="serif text-xl text-purple-200 mb-2">Chapter 3: The Galaxy</h3>
                <p class="serif italic">"Stars born from dust and endless space,<br>
                Orbiting time in a cosmic race.<br>
                Colors collide in the vast unknown,<br>
                A universe of seeds, softly sown."</p>
            `,
            rest: `
                <h3 class="serif text-xl text-pink-200 mb-2">Verse 2: What You Feel</h3>
                <p class="serif italic">"Paint your silence with a splash of hue,<br>
                A feeling taking shape, distinct and new.<br>
                Adjust the rhythm, shift the tone,<br>
                Create a world that is yours alone."</p>
            `
        };

        // --- Main Switcher Function ---
        function loadSketch(key) {
            const loading = document.getElementById('loading-indicator');
            loading.classList.remove('opacity-0');
            
            // Update Poetry
            const poetryDiv = document.getElementById('poetry-display');
            poetryDiv.style.opacity = '0';
            setTimeout(() => {
                poetryDiv.innerHTML = poetryContent[key];
                poetryDiv.style.opacity = '1';
            }, 300);

            // Cleanup previous sketch
            if (currentP5) {
                if (currentP5.mySound && currentP5.mySound.isPlaying()) {
                    currentP5.mySound.stop();
                }
                currentP5.remove(); // Removes canvas and hooks
                
                // Manually remove any lingering DOM elements (sliders, etc from Rest sketch)
                const oldControls = document.querySelectorAll('.p5-dom-control');
                oldControls.forEach(el => el.remove());
            }

            // Initialize new sketch
            let sketchFunc;
            switch(key) {
                case 'ocean': sketchFunc = sketchOcean; break;
                case 'forest': sketchFunc = sketchForest; break;
                case 'galaxy': sketchFunc = sketchGalaxy; break;
                case 'rest': sketchFunc = sketchRest; break;
            }

            currentP5 = new p5(sketchFunc, 'canvas-container');
            
            // Hide loading after a brief delay
            setTimeout(() => loading.classList.add('opacity-0'), 1500);
        }


        // ============================================================
        // SKETCH 1: THE OCEAN
        // ============================================================
        const sketchOcean = (p) => {
            let num = 1000;
            let particles_a = [], particles_b = [], particles_c = [];
            let fade = 200;
            let radius = 6.5;
            let speed_a = 0.5, speed_b = 0.5, speed_c = 0.75;
            let noiseScale = 300;
            let noiseStrength = 1.2;

            p.mySound = null;

            class Particle {
                constructor(l, s) {
                    this.loc = l;
                    this.dir = p.createVector(0, 0);
                    this.speed = s;
                    this.d = 1;
                }
                move(s) {
                    this.speed = s;
                    this.angle = p.noise(this.loc.x / noiseScale, this.loc.y / noiseScale, p.frameCount / noiseScale) * p.TWO_PI * noiseStrength;
                    this.dir.x = p.cos(this.angle);
                    this.dir.y = p.sin(this.angle) - p.cos(this.angle) * p.sin(this.angle);
                    this.vel = this.dir.copy();
                    this.vel.mult(this.speed * this.d);
                    this.loc.add(this.vel);
                }
                checkEdges() {
                    if (this.loc.x < 0) this.loc.x = p.width;
                    if (this.loc.x > p.width) this.loc.x = 0;
                    if (this.loc.y < 0) this.loc.y = p.height;
                    if (this.loc.y > p.height) this.loc.y = 0;
                }
                drawParticle(r) {
                    p.noStroke();
                    p.ellipse(this.loc.x, this.loc.y, r);
                }
            }

            p.preload = () => {
                p.mySound = p.loadSound(audioFiles.ocean);
            };

            p.setup = () => {
                p.createCanvas(p.windowWidth, p.windowHeight);
                init();
                if(p.mySound) {
                    p.mySound.setVolume(0.5);
                    p.mySound.loop();
                }
            };

            p.draw = () => {
                p.background(40, 100, 230, 15);
                
                for (let i = 0; i < num; i++) {
                    p.fill(255, 255, 90, fade);
                    particles_a[i].move(speed_a);
                    particles_a[i].checkEdges();
                    particles_a[i].drawParticle(radius);

                    p.fill(255, 100, 200, fade);
                    particles_b[i].move(speed_b);
                    particles_b[i].checkEdges();
                    particles_b[i].drawParticle(radius);

                    p.fill(60, 250, 250, fade);
                    particles_c[i].move(speed_c);
                    particles_c[i].checkEdges();
                    particles_c[i].drawParticle(radius);
                }
            };

            p.windowResized = () => {
                p.resizeCanvas(p.windowWidth, p.windowHeight);
                init();
            };

            function init() {
                p.background(0, 15);
                for (let i = 0; i < num; i++) {
                    let loc_a = p.createVector(p.random(p.width), p.random(p.height));
                    let loc_b = p.createVector(p.random(p.width), p.random(p.height));
                    let loc_c = p.createVector(p.random(p.width), p.random(p.height));
                    particles_a[i] = new Particle(loc_a, speed_a);
                    particles_b[i] = new Particle(loc_b, speed_b);
                    particles_c[i] = new Particle(loc_c, speed_c);
                }
            }
        };


        // ============================================================
        // SKETCH 2: THE FOREST
        // ============================================================
        const sketchForest = (p) => {
            const CLUSTER_COUNT = 24;
            const VINES_PER_CLUSTER = 6;
            const VINE_LENGTH = 100;
            const VINE_SPEED_RANGE = [0.8, 2.3];
            const VINE_CURVE_RANGE = 3;
            const VINE_COLOR_RANGE = [0, 255];
            const BACKGROUND_COLOR = [20, 50, 20];

            let clusters = [];
            p.mySound = null;

            class Vine {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.path = [];
                    this.color = p.color(
                        p.random(VINE_COLOR_RANGE[0], VINE_COLOR_RANGE[1]),
                        p.random(VINE_COLOR_RANGE[0], VINE_COLOR_RANGE[1]),
                        p.random(VINE_COLOR_RANGE[0], VINE_COLOR_RANGE[1]),
                        150
                    );
                    this.speed = p.random(VINE_SPEED_RANGE[0], VINE_SPEED_RANGE[1]);
                }
                update() {
                    this.y -= this.speed;
                    this.x += p.random(-VINE_CURVE_RANGE, VINE_CURVE_RANGE);
                    this.path.push(p.createVector(this.x, this.y));
                    if (this.path.length > VINE_LENGTH) this.path.shift();
                    
                    // Reset if goes off top
                    if (this.y < -50) {
                        this.y = p.height;
                        this.path = [];
                    }
                }
                show() {
                    p.stroke(this.color);
                    p.strokeWeight(2);
                    p.beginShape();
                    for (let v of this.path) {
                        p.curveVertex(v.x, v.y);
                    }
                    p.endShape();
                }
            }

            class Cluster {
                constructor(x, y, vineCount) {
                    this.vines = [];
                    for (let i = 0; i < vineCount; i++) {
                        this.vines.push(new Vine(x + p.random(-15, 15), y));
                    }
                }
                update() {
                    for (let vine of this.vines) vine.update();
                }
                show() {
                    for (let vine of this.vines) vine.show();
                }
            }

            p.preload = () => {
                p.mySound = p.loadSound(audioFiles.forest);
            };

            p.setup = () => {
                p.createCanvas(p.windowWidth, p.windowHeight);
                p.background(...BACKGROUND_COLOR);
                p.noFill();
                initClusters();
                if(p.mySound) {
                    p.mySound.setVolume(0.5);
                    p.mySound.loop();
                }
            };

            p.draw = () => {
                // Slight trail effect for magical feel
                p.background(20, 50, 20, 50); 
                for (let cluster of clusters) {
                    cluster.update();
                    cluster.show();
                }
            };

            p.windowResized = () => {
                p.resizeCanvas(p.windowWidth, p.windowHeight);
                initClusters();
            };

            function initClusters() {
                clusters = [];
                let spacing = p.width / (CLUSTER_COUNT + 1);
                for (let i = 0; i < CLUSTER_COUNT; i++) {
                    let clusterX = spacing * (i + 1);
                    clusters.push(new Cluster(clusterX, p.height, VINES_PER_CLUSTER));
                }
            }
        };


        // ============================================================
        // SKETCH 3: THE GALAXY
        // ============================================================
        const sketchGalaxy = (p) => {
            let palette1 = [[150, 0, 180], [220, 40, 0], [255, 0, 255], [255, 150, 80], [150, 0, 180], [180, 50, 220], [255, 200, 255], [255, 230, 150], [80, 0, 80]];
            let palette2 = [[255, 255, 102], [255, 255, 0], [255, 204, 0], [255, 240, 150], [255, 230, 70], [255, 150, 0], [100, 100, 0], [200, 200, 255], [255, 255, 200]];
            let palette3 = [[255, 204, 204], [255, 220, 230], [255, 240, 245], [255, 230, 200], [255, 248, 250], [250, 180, 200], [240, 240, 240], [255, 255, 255], [255, 102, 178]];

            let particles = [], stars = [], shootingStarsArr = [];
            const NUM1 = 600, NUM2 = 600, NUM3 = 800;
            const TOTAL_NUM = NUM1 + NUM2 + NUM3;
            const starNum = 900, shootingStarNum = 550;

            let currentParticles = 0;
            let currentShootingStars = 0;
            let PARTICLE_GROWTH_RATE = 0.2;
            let SHOOTING_GROWTH_RATE = 0.1;

            p.mySound = null;

            class Particle {
                constructor(palette, coreRadius, minRadius) {
                    this.coreRadius = coreRadius;
                    this.minRadius = minRadius;
                    this.baseRadius = p.random(this.minRadius, this.coreRadius - 50);
                    this.radius = this.baseRadius;
                    this.angle = p.random(p.TWO_PI);
                    this.speed = p.map(this.baseRadius, this.minRadius, this.coreRadius, 0.03, 0.005);
                    this.size = p.random(2, 5); // Adjusted size for mobile/web
                    this.offset = p.random(p.TWO_PI);
                    this.oscillationSpeed = p.random(0.1, 0.15);
                    this.wobbleAmount = this.baseRadius * p.random(0.015, 0.025);
                    this.c = p.color(p.random(palette));
                }
                update() {
                    this.angle += this.speed;
                    this.offset += this.oscillationSpeed;
                    this.radius = this.baseRadius + p.sin(this.offset) * this.wobbleAmount;
                }
                show() {
                    let x = this.radius * p.cos(this.angle);
                    let y = this.radius * p.sin(this.angle);
                    p.noStroke();
                    p.fill(this.c);
                    p.circle(x, y, this.size);
                }
            }

            class StaticStar {
                constructor() {
                    this.x = p.random(p.width);
                    this.y = p.random(p.height);
                    this.size = p.random(1, 3);
                }
                drawStar() {
                    p.noStroke();
                    p.fill(255);
                    p.circle(this.x, this.y, this.size);
                }
            }

            class ShootingStar {
                constructor() { this.init(); }
                init() {
                    let s = p.random(3, 5);
                    let colors = [[50, 200, 255], [50, 200, 255], [50, 235, 200]];
                    this.speed = p.createVector(-s, s * 1.2);
                    this.loc = p.createVector(p.random(p.width * 0.17, p.width + 50), p.random(-50, p.height * 0.87));
                    this.size = p.random(2, 6);
                    this.col = p.color(p.random(colors));
                }
                reset() { this.init(); }
                update() {
                    this.loc.add(this.speed);
                    if (this.loc.x < -50 || this.loc.y > p.height + 50) this.reset();
                }
                drawStar() {
                    p.noStroke();
                    p.fill(this.col);
                    p.circle(this.loc.x, this.loc.y, this.size);
                }
            }

            p.preload = () => {
                p.mySound = p.loadSound(audioFiles.galaxy);
            };

            p.setup = () => {
                p.createCanvas(p.windowWidth, p.windowHeight);
                p.angleMode(p.RADIANS);
                
                // Scale rings based on screen size
                let scale = Math.min(p.width, p.height) / 1000; 

                for (let i = 0; i < NUM1; i++) particles.push(new Particle(palette1, 300 * scale, 20));
                for (let i = 0; i < NUM2; i++) particles.push(new Particle(palette2, 450 * scale, 290 * scale));
                for (let i = 0; i < NUM3; i++) particles.push(new Particle(palette3, 650 * scale, 440 * scale));
                for (let i = 0; i < starNum; i++) stars.push(new StaticStar());
                for (let i = 0; i < shootingStarNum; i++) shootingStarsArr.push(new ShootingStar());

                if(p.mySound) {
                    p.mySound.setVolume(0.5);
                    p.mySound.loop();
                }
            };

            p.draw = () => {
                p.background(5, 0, 0, 20);

                PARTICLE_GROWTH_RATE *= 1.0015;
                SHOOTING_GROWTH_RATE *= 1.0008;
                currentParticles = p.min(TOTAL_NUM, currentParticles + PARTICLE_GROWTH_RATE);
                currentShootingStars = p.min(shootingStarNum, currentShootingStars + SHOOTING_GROWTH_RATE);

                for (let s of stars) s.drawStar();
                for (let i = 0; i < currentShootingStars; i++) {
                    let s = shootingStarsArr[i];
                    s.update();
                    s.drawStar();
                }

                p.push();
                p.translate(p.width / 2, p.height / 2);
                for (let i = 0; i < currentParticles; i++) {
                    let part = particles[i];
                    part.update();
                    part.show();
                }
                p.pop();
            };
            
            p.windowResized = () => {
                p.resizeCanvas(p.windowWidth, p.windowHeight);
            };
        };


        // ============================================================
        // SKETCH 4: WHAT YOU FEEL (REST)
        // ============================================================
        const sketchRest = (p) => {
            let numSplashes = 12;
            let nodes = 128;
            let grid = [];
            let noiseScale = 0.007;
            let currentColors = [[], [], [], [], []];
            let parameters = [0, 0, 0];

            let rSlider, gSlider, bSlider;
            let cx, cy; // Click coordinates

            p.mySound = null;

            p.preload = () => {
                p.mySound = p.loadSound(audioFiles.rest);
            };

            p.setup = () => {
                p.createCanvas(p.windowWidth, p.windowHeight);
                p.noStroke();

                // --- GUI (Created carefully to be removable) ---
                const uiContainer = document.getElementById('ui-layer');
                
                // Helper to make controls
                function makeControl(min, max, val, label, topOffset) {
                    let wrapper = document.createElement('div');
                    wrapper.className = 'p5-dom-control absolute left-10 interactive-area pointer-events-auto flex items-center gap-4';
                    wrapper.style.bottom = topOffset + 'px';
                    
                    let lab = document.createElement('span');
                    lab.innerText = label;
                    lab.className = 'text-white font-bold w-8';
                    
                    let slider = document.createElement('input');
                    slider.type = 'range';
                    slider.min = min;
                    slider.max = max;
                    slider.value = val;
                    slider.className = 'w-32 md:w-48';

                    wrapper.appendChild(lab);
                    wrapper.appendChild(slider);
                    uiContainer.appendChild(wrapper);
                    return slider;
                }

                rSlider = makeControl(0, 255, 127, 'R', 120);
                gSlider = makeControl(0, 255, 127, 'G', 80);
                bSlider = makeControl(0, 255, 127, 'B', 40);

                // --- PERLIN GRID SETUP ---
                for (let i = 0; i < nodes * nodes; i++) {
                    const angle = p.random(p.TWO_PI);
                    grid.push([p.cos(angle), p.sin(angle)]);
                }

                fillBackground();
                if(p.mySound) {
                    p.mySound.setVolume(0.5);
                    p.mySound.loop();
                }
            };

            p.draw = () => {
                // Index circle updates in real time
                // Position it near the sliders
                drawIndexCircle(rSlider.value, gSlider.value, bSlider.value);
            };

            p.mousePressed = () => {
                // Only splash if clicking on canvas, not on controls
                if (p.mouseY < p.height - 150) {
                    cx = p.mouseX;
                    cy = p.mouseY;
                    drawSplashes();
                }
            };

            function drawSplashes() {
                let r_val = parseInt(rSlider.value);
                let g_val = parseInt(gSlider.value);
                let b_val = parseInt(bSlider.value);

                for (let i = 0; i < currentColors.length; i++) {
                    currentColors[i] = [
                        p.random(r_val - 50, r_val + 50),
                        p.random(g_val - 50, g_val + 50),
                        p.random(b_val - 50, b_val + 50),
                    ];
                }
                for (let i = 0; i < numSplashes; i++) splash();
            }

            function fillBackground() {
                p.background(255);
                p.noStroke();
                p.fill(240, 240, 230);
                // Center rect
                p.rect(20, 20, p.width - 40, p.height - 40);
            }

            function splash() {
                let radius = p.width / 3; 
                for (let i = 0; i < 4; i++) radius = p.random(10, radius);

                const numStains = parseInt(p.random(3, radius / 2));

                for (let i = 0; i < numStains; i++) {
                    const angle = p.random(p.TWO_PI);
                    const stain_x = cx + radius * p.cos(angle);
                    const stain_y = cy + radius * p.sin(angle);
                    const r = p.abs(p.randomGaussian(20, 15)) * p.random(0, p.random(0, 1));
                    drawStain(stain_x, stain_y, r);
                }
            }

            function drawStain(cx, cy, r) {
                if (r <= 0) return;
                const noiseVal = perlin(cx * noiseScale, cy * noiseScale);
                const colorIndex = parseInt(p.map(noiseVal, -1, 1, 0, 8)) % currentColors.length;
                const clr = currentColors[colorIndex];
                if (!clr) return; 

                let alpha = p.random(20, 120);
                p.fill(clr[0], clr[1], clr[2], alpha);
                p.ellipse(cx, cy, r * 2, r * 2);
            }

            function drawIndexCircle(r_val, g_val, b_val) {
                p.push();
                p.noStroke();
                p.fill(r_val, g_val, b_val);
                // Draw circle near sliders
                p.circle(60, p.height - 160, 50);
                p.pop();
            }

            // Perlin Implementation
            function perlin(x, y) {
                let x0 = Math.floor(x);
                let x1 = x0 + 1;
                let y0 = Math.floor(y);
                let y1 = y0 + 1;
                let dot_LT = dot([x - x0, y - y0], grid[(x0 & 127) + (y0 & 127) * nodes]);
                let dot_RT = dot([x - x1, y - y0], grid[(x1 & 127) + (y0 & 127) * nodes]);
                let dot_LB = dot([x - x0, y - y1], grid[(x0 & 127) + (y1 & 127) * nodes]);
                let dot_RB = dot([x - x1, y - y1], grid[(x1 & 127) + (y1 & 127) * nodes]);
                let top = lerpSmooth(dot_LT, dot_RT, x - x0);
                let bottom = lerpSmooth(dot_LB, dot_RB, x - x0);
                return lerpSmooth(top, bottom, y - y0);
            }
            function dot(a, b) { return a[0] * b[0] + a[1] * b[1]; }
            function lerpSmooth(a, b, t) {
                let ts = 6 * t ** 5 - 15 * t ** 4 + 10 * t ** 3;
                return a * (1 - ts) + b * ts;
            }
        };
    </script>
</body>
</html>